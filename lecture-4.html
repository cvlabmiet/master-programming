<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru-RU" xml:lang="ru-RU">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Игорь Шаронов" />
  <meta name="date" content="2018-03-10" />
  <title>Master Programming</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" data-external="1"/>
  <style type="text/css">
      .reveal h1 { font-size: 2em; }
      .reveal h2 { font-size: 2em; }
      .reveal h3 { font-size: 1em; }
      .reveal pre code { max-height: 600px; }
      div.column33 {display: inline-block; vertical-align: top; width: 32%;}
      div.column66 {display: inline-block; vertical-align: top; width: 66%;}
      div.column50 {display: inline-block; vertical-align: top; width: 49%;}
      .strike {text-decoration: line-through;}
      table, th, td {
          border: 1px solid black;
      }
  </style>
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript" data-external="1"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Master programming</h1>
  <p class="subtitle">Лекция №4 (Отладка)</p>
  <p class="author">
Игорь Шаронов
  </p>
  <p class="date">2018-03-10</p>
</div>
<div id="из-чего-состоит-программа" class="title-slide slide section level1"><h1>Из чего состоит программа?</h1></div><div id="этапы-сборки-программы" class="slide section level2">
<h1>Этапы сборки программы</h1>
<p>Полную сборку (<code>g++ -o exe main.cpp</code>) можно разбить на этапы:</p>
<ol>
<li>препроцессинг (<code>g++ -E</code>) → исходный файл для компиляции</li>
<li>компиляция (<code>g++ -c</code>) → объектный файл</li>
<li>создание библиотечного архива (<code>ar -r</code>) → статическая библиотека</li>
<li>линковка (<code>ld</code> или <code>g++</code>) → исполняемый файл или динамическая библиотека</li>
</ol>
</div><div id="изучение-объектного-файла" class="slide section level2">
<h1>Изучение объектного файла</h1>
<p>Существуют несколько форматов объектных файлов:</p>
<ul>
<li>COFF — для Windows (ранее использовался в UNIX)</li>
<li>Mach-O — Mac OS X, iOS</li>
<li>ELF — для исполнимых файлов и динамических библиотек (Linux-системы)</li>
</ul>
<p>Основные секции:</p>
<ul>
<li>.text — секция кода</li>
<li>.data — секция данных</li>
<li>.rodata — секция констант</li>
<li>.bss — секция неинициализированных данных</li>
</ul>
</div><div id="список-символов" class="slide section level2">
<h1>Список символов</h1>
<ul>
<li><p>Утилита для вывода списка символов в объектном файле – <code>nm</code> (name mangling)</p></li>
<li><p>Метод подходит для объектных файлов, статических и динамических библиотек и исполнимых файлов:</p>
<pre><code>$ nm fuse/elsimdrv | less

000000000066f000 d _GLOBAL_OFFSET_TABLE_
0000000000407f6a t _GLOBAL__sub_I_main
00000000004388b0 t _GLOBAL__sub_I__ZN7simfuse9simfuse_t13ioctl_commandIL13eldrv_ioctl_e3222850823EEEiPvS3_PKc
00000000004326a1 t _GLOBAL__sub_I__ZN7simfuse9simfuse_tC2ERKNSt7__cxx1112basic_stringIcSt11char_traitsIc...
                 w __gmon_start__
0000000000450538 r __GNU_EH_FRAME_HDR
                 U __gxx_personality_v0@@CXXABI_1.3
00000000004068f0 T _init
000000000066ea10 t __init_array_end
000000000066e9f0 t __init_array_start
000000000044e640 R _IO_stdin_used</code></pre></li>
<li><p>Выводит смещение, тип символа и название функции (до манглинга)</p></li>
<li><p>Типы символов: undefined, weak, text, data, … (<code>man nm</code>)</p></li>
</ul>
</div><div id="изучение-секций" class="slide section level2">
<h1>Изучение секций</h1>
<ul>
<li><p>Утилита <code>readelf</code></p></li>
<li><p>Выводит адреса секций, используемых библиотек, rpath, содержимого секций</p></li>
<li><p>Вывод всей доступной информации: <code>$ readelf -W -a fuse/elsimdrv | less</code></p></li>
<li><p>Вывод содержимого секции: <code>$ readelf -p .text fuse/elsimdrv | less</code></p></li>
<li><p>Добавлять свои секции можно через скрипты линковки</p></li>
<li><p>Есть способ добавлять символы в секции внутри исходного кода (зависит от компилятора):</p>
<pre><code>// если в глобальной пространстве имён
static int a; // .bss
const int B = 44; // .rodata
int bb[] = {0, 5, 8, 9}; // .data
// через атрибуты
extern void foobar() __attribute__((section(&quot;bar&quot;)));</code></pre></li>
</ul>
</div><div id="динамическая-и-статическая-линковки" class="slide section level2">
<h1>Динамическая и статическая линковки</h1>
<ul>
<li>Статическая линковка — линковка со объектыми файлами и статическими библиотеками</li>
<li>Динамическая линковка — линковка с динамическими библиотеками
<ul>
<li>только разрешение имён</li>
<li>код не встраивается в объектный файл</li>
<li>библиотеку можно подменить при вызове</li>
<li>будет использован первый загруженный символ (<code>LD_PRELOAD</code>)</li>
<li>so-версионность</li>
</ul></li>
<li>Позиционно независимый код (<code>-fPIC</code>) для динамических объектов</li>
<li>Загрузку секций можно изменять с помощью ld-скриптов</li>
</ul>
</div>
<div id="как-работает-программа" class="title-slide slide section level1"><h1>Как работает программа?</h1></div><div id="запуск-программы" class="slide section level2">
<h1>Запуск программы</h1>
<ul>
<li>В действительности выполняется команда <code>/lib/ld-linux-x86-64.so ./program</code></li>
<li>Работа загрузчика динамических библиотек:
<ul>
<li>найти все используемые динамические библиотеки</li>
<li>для поиска используются:
<ul>
<li>rpath объектного файла</li>
<li>LD_LIBRARY_PATH</li>
<li>LD_PRELOAD для перегрузки функций</li>
<li><code>/etc/ld.so.cache</code></li>
</ul></li>
<li>загрузка найденных библиотек и их зависимостей</li>
<li>загрузка и запуск программы</li>
</ul></li>
<li><code>ldd</code> — узнать список загружаемых библиотек</li>
<li>Если в программе нет динамической зависимости, загрузчик не используется</li>
</ul>
</div><div id="трассировка-программы" class="slide section level2">
<h1>Трассировка программы</h1>
<ul>
<li><p><code>ltrace</code> позволяет выводить в реальном времени вызовы динамических библиотек</p></li>
<li><p><code>strace</code> — вывод системных вызовов</p></li>
<li><p>Системный вызов — выполняется ядром (<code>man syscalls</code>):</p>
<pre><code>$ strace ls
execve(&quot;/nix/store/cb3slv3szhp46xkrczqw7mscy5mnk64l-coreutils-8.29/bin/ls&quot;, [&quot;ls&quot;], 0x7ffe1f4b0c50 /* 143 vars */) = 0
brk(NULL)                               = 0x2276000
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f3e0ff22000
access(&quot;/etc/ld-nix.so.preload&quot;, R_OK)  = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, &quot;/run/opengl-driver/lib/tls/haswell/x86_64/librt.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
stat(&quot;/run/opengl-driver/lib/tls/haswell/x86_64&quot;, 0x7fffcefcb4e0) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, &quot;/run/opengl-driver/lib/tls/haswell/librt.so.1&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
stat(&quot;/run/opengl-driver/lib/tls/haswell&quot;, 0x7fffcefcb4e0) = -1 ENOENT (No such file or directory)
...</code></pre></li>
<li><p><code>strace -c</code> — простейший профайлер системных вызовов</p></li>
</ul>
</div>
<div id="как-отладить-программу" class="title-slide slide section level1"><h1>Как отладить программу?</h1></div><div id="система-отладки-gdb" class="slide section level2">
<h1>Система отладки GDB</h1>
<ul>
<li>GDB — GNU Debugger</li>
<li>Подобен интерпретатору</li>
<li>Есть скриптовый режим</li>
<li>Можно писать собственные плагины</li>
<li>Поддерживает режим TUI</li>
<li>Отладка крешдампов</li>
<li>Почему у меня не видно символов? Нужны отладочные символы:
<ul>
<li><code>g++ -g -O0</code></li>
<li><code>cmake -DCMAKE_BUILD_TYPE=Debug &lt;source_dir&gt;</code> — дебаг-режим</li>
<li><code>cmake -DCMAKE_BUILD_TYPE=Release &lt;source_dir&gt;</code> — релиз-режим (обычно соответствует <code>-O3</code>)</li>
</ul></li>
<li><code>gdb-server</code> — удалённая отладка</li>
</ul>
</div><div id="команды-gdb" class="slide section level2">
<h1>Команды GDB</h1>
<ul>
<li><code>gdb ./progname</code> — загрузка программы в отладчик</li>
<li><code>break</code> или <code>break &lt;linenumber&gt;</code> — точка останова</li>
<li><code>run [args]</code> — запуск программы с аргументами <code>args</code></li>
<li><code>continue</code> — продолжение выполнения программы</li>
<li><code>step</code> (<code>stepi</code>), <code>next</code> (<code>nexti</code>) — пошаговое выполнение</li>
<li><code>backtrace</code> — получение бэктрейса</li>
<li><code>frame &lt;num&gt;</code> — перейти на <code>&lt;num&gt;</code> уровень стека из бэктрейса</li>
<li><code>up</code>, <code>down</code> — пемерещения по уровням стека</li>
<li><code>thread &lt;num&gt;</code> — перемещение по потокам</li>
<li><code>quit</code> или комбинация Ctrl-D — завершение отладки</li>
<li>можно писать только первые буквы команд</li>
</ul>
</div>
<div id="дополнительные-системы-отладки" class="title-slide slide section level1"><h1>Дополнительные системы отладки</h1></div><div id="ещё-способы-отладки" class="slide section level2">
<h1>Ещё способы отладки</h1>
<ul>
<li><p>Ключи компиляции: <code>-Wall</code>, <code>-pedantic</code>, <code>-Wextra</code>, <code>-fsanitize</code></p></li>
<li><p>Запуск программы через memchecker</p></li>
<li><p>Valgrind:</p>
<pre><code>==8736== Invalid write of size 8
==8736==    at 0x4C31133: memcpy@GLIBC_2.2.5 (in /lib/vgpreload_memcheck-amd64-linux.so)
==8736==    by 0x4813B4: dma_copy_data (dma.c:48)
==8736==    by 0x4815EE: dma_copy2d (dma.c:110)
==8736==    by 0x47CFC0: copy_block_unsafe (copy_block.c:49)
==8736==    by 0x47D549: copy_real_part (copy_block.c:259)
==8736==    by 0x47DA75: copy_block_by_replicate_border (copy_block.c:362)
==8736==    by 0x47E2C2: copy_block (copy_block.c:554)
==8736==    by 0x480BB8: copy_output (parallel_context.c:60)
==8736==    by 0x4810BE: wait_last (parallel_context.c:175)
==8736==    by 0x47F681: iterate_through_static_tiles (tile_segmentation.c:436)
==8736==    by 0x47FE71: tile_segmentation (tile_segmentation.c:567)
==8736==    by 0x47233A: kernel_CombinePlane_3 (kernel_ChannelCombine.c:110)
==8736==  Address 0x6bb1bc0 is 0 bytes after a block of size 307,200 alloc&#39;d
==8736==    at 0x4C2F126: memalign (in /lib/vgpreload_memcheck-amd64-linux.so)
==8736==    by 0x454109: vxAllocatePlane (vx_image.c:203)
==8736==    by 0x454974: vxInitializeImage (vx_image.c:341)
==8736==    by 0x454A46: vxCreateImage (vx_image.c:358)
==8736==    by 0x415DF4: main (sampleMinMaxLoc.c:65)</code></pre></li>
</ul>
</div><div id="остановка-в-дебаггере-при-утечке-памяти" class="slide section level2">
<h1>Остановка в дебаггере при утечке памяти</h1>
<div class="column50">
<pre class=""><code>$ valgrind --vgdb=yes --vgdb-error=0 prog
==20836== Memcheck, a memory error detector
==20836== Copyright (C) 2002-2011, and GNU GPL&#39;d, by Julian Seward et al.
==20836== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==20836== Command: /tmp/e
==20836==
==20836== (action at startup) vgdb me ...
==20836==
==20836== TO DEBUG THIS PROCESS USING GDB: start GDB like this
==20836==   /path/to/gdb /tmp/e
==20836== and then give GDB the following command
==20836==   target remote | vgdb --pid=20836
==20836== --pid is optional if only one valgrind process is running
==20836==</code></pre>
</div>
<div class="column50">
<pre class=""><code>$ gdb ./prog
(gdb) target remote | vgdb
Remote debugging using | vgdb
relaying data between gdb and process 2418
Reading symbols from /lib/ld-linux.so.2...done.
Reading symbols from /usr/lib/debug/lib/ld-2.11.2.so.debug...done.
Loaded symbols for /lib/ld-linux.so.2
[Switching to Thread 2418]
0x001f2850 in _start () from /lib/ld-linux.so.2
(gdb) ...
(gdb) monitor exit</code></pre>
</div>
</div>
</body>
</html>
